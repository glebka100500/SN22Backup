<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_metadata_link">
    <sys_metadata_link action="INSERT_OR_UPDATE">
        <directory>update</directory>
        <documentkey>1be5292d9fe03200598a5bb0657fcf8a</documentkey>
        <payload>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;record_update table="sys_script_include"&gt;
    &lt;sys_script_include action="INSERT_OR_UPDATE"&gt;
        &lt;access&gt;public&lt;/access&gt;
        &lt;active&gt;true&lt;/active&gt;
        &lt;api_name&gt;global.PercentCompleteHelper&lt;/api_name&gt;
        &lt;caller_access/&gt;
        &lt;client_callable&gt;false&lt;/client_callable&gt;
        &lt;description/&gt;
        &lt;name&gt;PercentCompleteHelper&lt;/name&gt;
        &lt;script&gt;&lt;![CDATA[// PercentComplete Helper
var PercentCompleteHelper = Class.create();
PercentCompleteHelper.prototype = {
    PERCENT_COMPLETE_STACK: "percent_complete_stack_",

    initialize: function() {
        this.json = new JSON();
    },

    getStack: function(sysId) {
        if(JSUtil.notNil(sysId)) {
            var percentCompleteStack = gs.getSession().getProperty(this.PERCENT_COMPLETE_STACK + sysId);
            if(JSUtil.notNil(percentCompleteStack)) {
                return this.json.decode(percentCompleteStack);   
            }
        }
    },
	
	//OOB unused method
    putStack: function(sysId, percentCompleteStack) {
        var percentCompleteStackString = this.json.encode(percentCompleteStack);
        gs.getSession().putProperty(this.PERCENT_COMPLETE_STACK + sysId, percentCompleteStackString);
    },

	//OOB unused method
    clearStack: function(gr) {
        var topTaskId = gr.getValue("top_task");
        gs.print("PercentCompleteHelper.clearStack -&gt; " + topTaskId);
        if(JSUtil.notNil(topTaskId)) {
            var percentCompleteStack = this.getStack(topTaskId);
            if(JSUtil.notNil(percentCompleteStack)) {
                gs.getSession().clearProperty(this.PERCENT_COMPLETE_STACK + topTaskId);
            } // else do nothing
        }
    },

	//OOB unused method
    process: function(gr) {
        var arrayUtil = new ArrayUtil();
        var sysId = gr.getValue("sys_id");
        var topTaskId = gr.getValue("top_task");
        
        var percentCompleteStack;
        if( JSUtil.notNil(topTaskId) ) {
            percentCompleteStack = this.getStack(topTaskId);
            // gs.print("PercentCompleteHelper - percentCompleteStack  -&gt; " + this.json().encode(percentCompleteStack));
            if(JSUtil.nil(percentCompleteStack) || 
                JSUtil.nil(percentCompleteStack.level) || JSUtil.nil(percentCompleteStack.sys_id)){
                percentCompleteStack = {};
                var topTask = new GlideRecord("planned_task");
                topTask.addQuery("top_task", topTaskId);
                topTask.orderByDesc("level");
                topTask.chooseWindow(0, 1, false);
                topTask.query();
                if(topTask.next()) {
                    percentCompleteStack.level = topTask.getValue("level");
                    percentCompleteStack.sys_id = topTask.getValue("sys_id");
                }
                gs.print("PercentCompleteHelper - Saving percentCompleteStack -&gt; " + this.json.encode(percentCompleteStack));
                this.putStack(topTaskId, percentCompleteStack);
            }
        } // else do nothing 
    },

    canRollup: function(gr) {
        var arrayUtil = new ArrayUtil();
        var sysId = gr.getValue("sys_id");
        var topTaskId = gr.getValue("top_task");
        //gs.print("canRollup: sysId: " + sysId + " -- topTaskId: " + topTaskId);
        var percentCompleteStack;
        if( JSUtil.notNil(topTaskId) ) {
            percentCompleteStack = this.getStack(topTaskId);
            if( JSUtil.notNil(percentCompleteStack) ) {
                gs.print("Igonoring Percent Complete -&gt; " + this.json.encode(percentCompleteStack));
                return false;
            }
        }
        gs.print("*** Unable to fetch the percentCompleteStack!! --&gt; Can Rollup -&gt; true");
        return true;
    },

	//OOB unused method
    rollup: function (gr) {
        gs.print("PercentCompleteHelper.rollup -&gt; " + gr.getValue("sys_id"));
        var sysId = gr.getValue("sys_id");
        var topTaskId = gr.getValue("top_task");
        if( JSUtil.notNil(topTaskId) ) {
            var percentCompleteStack = this.getStack(topTaskId);
            if( JSUtil.notNil(percentCompleteStack) &amp;&amp; JSUtil.notNil(percentCompleteStack.sys_id) ) {
                gs.print("PercentCompleteHelper.sys_id -&gt; " + percentCompleteStack.sys_id);
                var rollupAPI = new RollupAPI(); 
                var lowestTask = new GlideRecord("planned_task");
                if(lowestTask.get(percentCompleteStack.sys_id)) {
                    rollupAPI.rollup(lowestTask, 'percent_complete', true);
                }
            }
        }
    },

    type: 'PercentCompleteHelper'
};]]&gt;&lt;/script&gt;
        &lt;sys_class_name&gt;sys_script_include&lt;/sys_class_name&gt;
        &lt;sys_created_by&gt;admin&lt;/sys_created_by&gt;
        &lt;sys_created_on&gt;2017-01-26 01:51:39&lt;/sys_created_on&gt;
        &lt;sys_id&gt;1be5292d9fe03200598a5bb0657fcf8a&lt;/sys_id&gt;
        &lt;sys_mod_count&gt;12&lt;/sys_mod_count&gt;
        &lt;sys_name&gt;PercentCompleteHelper&lt;/sys_name&gt;
        &lt;sys_package display_value="Planned Task_v2" source="com.snc.planned_task_v2"&gt;e93557642fc10110d8a4d5f62799b623&lt;/sys_package&gt;
        &lt;sys_policy/&gt;
        &lt;sys_scope display_value="Global"&gt;global&lt;/sys_scope&gt;
        &lt;sys_update_name&gt;sys_script_include_1be5292d9fe03200598a5bb0657fcf8a&lt;/sys_update_name&gt;
        &lt;sys_updated_by&gt;admin&lt;/sys_updated_by&gt;
        &lt;sys_updated_on&gt;2018-08-07 11:53:46&lt;/sys_updated_on&gt;
        &lt;u_script_length&gt;4209&lt;/u_script_length&gt;
    &lt;/sys_script_include&gt;
&lt;/record_update&gt;
</payload>
        <sys_class_name>sys_metadata_link</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2022-12-19 20:26:15</sys_created_on>
        <sys_id>464c097a2f331110d8a4d5f62799b64e</sys_id>
        <sys_name>PercentCompleteHelper</sys_name>
        <sys_package display_value="Integrations 2022" source="x_644088_integrati">4c7ca0582f0c9110d8a4d5f62799b66d</sys_package>
        <sys_policy/>
        <sys_scope display_value="Integrations 2022">4c7ca0582f0c9110d8a4d5f62799b66d</sys_scope>
        <sys_update_name>sys_metadata_link_464c097a2f331110d8a4d5f62799b64e</sys_update_name>
        <tablename>sys_script_include</tablename>
    </sys_metadata_link>
</record_update>
