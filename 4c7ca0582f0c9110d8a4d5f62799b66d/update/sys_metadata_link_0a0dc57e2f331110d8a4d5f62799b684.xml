<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_metadata_link">
    <sys_metadata_link action="INSERT_OR_UPDATE">
        <directory>update</directory>
        <documentkey>8f3a2778c0a8002700fbde5ad148abe3</documentkey>
        <payload>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;record_update table="sys_script_include"&gt;
    &lt;sys_script_include action="INSERT_OR_UPDATE"&gt;
        &lt;access&gt;package_private&lt;/access&gt;
        &lt;active&gt;true&lt;/active&gt;
        &lt;api_name&gt;global.CatalogTransactionCheckout&lt;/api_name&gt;
        &lt;caller_access/&gt;
        &lt;client_callable&gt;false&lt;/client_callable&gt;
        &lt;description&gt;Checks you out (orders the contents of your cart) and redirects you to the order summary screen.&amp;#13;
If running in two step checkout mode this is the first step, so instead of checking you out it instead puts you on the cart summary screen.&lt;/description&gt;
        &lt;name&gt;CatalogTransactionCheckout&lt;/name&gt;
        &lt;script&gt;&lt;![CDATA[gs.include('PrototypeServer');
gs.include('AbstractTransaction');

var CatalogTransactionCheckout = Class.create();

CatalogTransactionCheckout.prototype = Object.extendsObject(AbstractTransaction, {

    execute: function() {
        var catalog = this.request.getParameter("sysparm_catalog");
        var catalogView = this.request.getParameter("sysparm_catalog_view");
        var cartName = this.request.getParameter("sysparm_cart_name");
        var parentID = this.request.getParameter("sysparm_parent_sys_id");
        var parentTable = this.request.getParameter("sysparm_parent_table");
		var paramRequestedFor = this.request.getParameter("sysparm_requested_for");
        var viewName = this.request.getParameter("sysparm_view");
        var params = {
            "sysparm_parent_sys_id": parentID,
            "sysparm_parent_table": parentTable,
            "sysparm_view": viewName
        };
        var cart;
        if (!JSUtil.nil(cartName))
            cart = GlideappCart.get(cartName);
        else
            cart = GlideappCart.get();
		
        if (!cart.getCartItems().hasNext()) {
            gs.addInfoMessage(gs.getMessage("Cannot check out with an empty cart!"));
            return gs.getSession().getStack().purge("com.glideapp.servicecatalog");
        }

		var requestForSysID = new global.GlobalServiceCatalogUtil().getRequestForSysID(parentTable, parentID) || paramRequestedFor;
		if (JSUtil.notNil(requestForSysID))
            cart.setRequestedFor(requestForSysID);
		
        var twoStep = gs.getProperty("glide.sc.checkout.twostep", "false") == 'true' &amp;&amp; !cart.checkAllItemsHaveRequestedFor();
        if (twoStep) {
			if (!this._validateCart(cart))
				return;
			
            if (!JSUtil.nil(cartName))
                return SNC.CatalogURLGenerator.getRedirectPreviewOrderWithParams(catalog, catalogView, cartName, params);
            else
				return GlideappCatalogURLGenerator.getRedirectOneStageCheckoutWithParams(catalog, catalogView, params);
		}
        return this._checkout(catalog, catalogView, cartName);
    },

    _checkout: function(catalog, catalogView, cartName) {
		try {
			var view = this.request.getParameter("sysparm_view");
			if (!view)
				view = "ess";
			var parentID = this.request.getParameter("sysparm_parent_sys_id");
			var parentTable = this.request.getParameter("sysparm_parent_table");
			var params = {};
			params.sysparm_parent_sys_id = parentID;
			params.sysparm_parent_table = parentTable;
			var req = new GlideappRequestNew();
			req.setParentParams(params);

			var requestRecord;
			var cart;
			if (!JSUtil.nil(cartName)) {
				requestRecord = req.copyCart(cartName);
				cart = GlideappCart.get(cartName);
			} else {
				requestRecord = req.copyCart();
				cart = GlideappCart.get();
			}
			var isNewOrderNow = gs.getProperty("glide.sc.enable_order_now", "false");
			if (isNewOrderNow == 'true' &amp;&amp; !JSUtil.nil(cartName) &amp;&amp; cartName.startsWith('cart_')) {
				var def_cart;
				def_cart = GlideappCart.get();

				// reset requested_for and special instructions property for default cart
				def_cart.setRequestedFor(gs.getUserID());
				def_cart.setSpecialInstructions('');

				//for new order now, an entry was inserted in default cart, on successful checkout, that entry needs to be deleted
				var id = gs.getSession().getProperty("default_cart_item");
				if (!JSUtil.nil(id)) {
					def_cart.remove(id);
					gs.getSession().clearProperty("default_cart_item");
				}
			}
			cart.empty();
			return this._checkoutRedirect(view, catalog, catalogView, requestRecord);
		} catch(e) {
			var catalogExceptionUtils = new CatalogExceptionUtils();
			if(catalogExceptionUtils.isCartException(e)) {
				return catalogExceptionUtils.handleCartException(e);
			}
			gs.debug(e);
		}
    },

    _checkoutRedirect: function(view, catalog, catalogView, requestRecord) {
        // If an alternative redirect was specified, use it!
        var altRedirect = this.request.getParameter("sysparm_redirect");
        if (!GlideSecurityUtils.isURLWhiteListedStrict(altRedirect))
        	altRedirect = GlideSecurityUtils.enforceRelativeURL(altRedirect);
        if (!gs.nil(altRedirect)) {
            gs.addInfoMessage(gs.getMessage('Your request has been placed: {0}', '&lt;a href="' + requestRecord.getLink() + '"&gt;' + requestRecord.number + '&lt;/a&gt;'));
            return altRedirect;
        }
        var checkoutForm = gs.getProperty("glide.sc.checkout.form", "com.glideapp.servicecatalog_checkout_view");
        if (!checkoutForm) {
            gs.addErrorMessage(gs.getMessage("Invalid or empty checkout form specified in property : glide.sc.checkout.form"));
            return "home.do";
        }
        if (!view)
            view = "";
        var parentID = this.request.getParameter("sysparm_parent_sys_id");
        var parentTable = this.request.getParameter("sysparm_parent_table");
        var viewName = this.request.getParameter("sysparm_view");
        var params = {
            "sysparm_parent_sys_id": parentID,
            "sysparm_parent_table": parentTable,
            "sysparm_view": viewName
        };
        answer = GlideappCatalogURLGenerator.getCheckoutURLForPageWithParams(checkoutForm, requestRecord.sys_id, view, catalog, catalogView, params);
        return answer;
    },
	
	_validateCart: function(cart) {
		var msg = cart.validateCartItems();
		if (msg != "valid") {
			gs.addErrorMessage(msg);
			var urlStack = j2js(gs.getSession().getStack());
			this.response.sendRedirect(urlStack.pop());
			return false;
		}
		return true;
	}
});]]&gt;&lt;/script&gt;
        &lt;sys_class_name&gt;sys_script_include&lt;/sys_class_name&gt;
        &lt;sys_created_by&gt;glide.maint&lt;/sys_created_by&gt;
        &lt;sys_created_on&gt;2008-09-23 12:41:05&lt;/sys_created_on&gt;
        &lt;sys_id&gt;8f3a2778c0a8002700fbde5ad148abe3&lt;/sys_id&gt;
        &lt;sys_mod_count&gt;94&lt;/sys_mod_count&gt;
        &lt;sys_name&gt;CatalogTransactionCheckout&lt;/sys_name&gt;
        &lt;sys_package display_value="Service Catalog Platform" source="com.glideapp.servicecatalog.platform"&gt;6d218d0f6d2620100acb70b35343303c&lt;/sys_package&gt;
        &lt;sys_policy/&gt;
        &lt;sys_scope display_value="Global"&gt;global&lt;/sys_scope&gt;
        &lt;sys_update_name&gt;sys_script_include_8f3a2778c0a8002700fbde5ad148abe3&lt;/sys_update_name&gt;
        &lt;sys_updated_by&gt;admin&lt;/sys_updated_by&gt;
        &lt;sys_updated_on&gt;2021-05-21 04:36:34&lt;/sys_updated_on&gt;
        &lt;u_script_length&gt;5558&lt;/u_script_length&gt;
    &lt;/sys_script_include&gt;
&lt;/record_update&gt;
</payload>
        <sys_class_name>sys_metadata_link</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2022-12-19 20:29:32</sys_created_on>
        <sys_id>0a0dc57e2f331110d8a4d5f62799b684</sys_id>
        <sys_name>CatalogTransactionCheckout</sys_name>
        <sys_package display_value="Integrations 2022" source="x_644088_integrati">4c7ca0582f0c9110d8a4d5f62799b66d</sys_package>
        <sys_policy/>
        <sys_scope display_value="Integrations 2022">4c7ca0582f0c9110d8a4d5f62799b66d</sys_scope>
        <sys_update_name>sys_metadata_link_0a0dc57e2f331110d8a4d5f62799b684</sys_update_name>
        <tablename>sys_script_include</tablename>
    </sys_metadata_link>
</record_update>
