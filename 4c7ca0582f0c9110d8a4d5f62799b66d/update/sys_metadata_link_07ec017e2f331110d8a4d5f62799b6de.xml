<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_metadata_link">
    <sys_metadata_link action="INSERT_OR_UPDATE">
        <directory>update</directory>
        <documentkey>8403647bb712230026778d78ee11a950</documentkey>
        <payload>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;record_update table="sys_script_include"&gt;
    &lt;sys_script_include action="INSERT_OR_UPDATE"&gt;
        &lt;access&gt;public&lt;/access&gt;
        &lt;active&gt;true&lt;/active&gt;
        &lt;api_name&gt;global.KnowledgeAjaxSNC&lt;/api_name&gt;
        &lt;caller_access/&gt;
        &lt;client_callable&gt;false&lt;/client_callable&gt;
        &lt;description&gt;Invoked from knowledge articles  Customers should not change this class directly This class is never called directly.&lt;/description&gt;
        &lt;name&gt;KnowledgeAjaxSNC&lt;/name&gt;
        &lt;script&gt;&lt;![CDATA[var KnowledgeAjaxSNC = Class.create();

KnowledgeAjaxSNC.prototype = Object.extendsObject(AbstractAjaxProcessor, {
	
	/**
 	* Prevent public access to this script
 	*/
	isPublic: function() {
		return false;
	},
	
	process: function() {
		if (type == "kbWriteComment")
			this.kbWriteComment();
		else if (type == "kbGetText")
			this.kbGetText(value);
		else if (type == "kbAttachArticle")
			this.kbAttachArticle(value);
		else if(type == 'subscribeKbArticle') {
			var sub_obj_id = this.getParameter("sysparm_article_id");
			var subs_obj_type_id = this.getParameter("sysparm_subs_obj_type_id");
			this.subscribeKbArticle(sub_obj_id,subs_obj_type_id);
		}
		else if(type == 'unsubscribeKbArticle') {
			var sub_obj_id = this.getParameter("sysparm_article_id");
			this.unsubscribeKbArticle(sub_obj_id);
		}
		else if(type == 'unsubscribeKB') {
			var sub_obj_id = this.getParameter("sysparm_article_id");
			var sub_obj_kb_id = this.getParameter("sysparm_kb_id"); 
			return this.unsubscribeKB(sub_obj_id,sub_obj_kb_id);
		}
		else if(type == 'verifyArticleTemplatesEnabled'){
			return this.verifyArticleTemplatesEnabled();
		}
		else if(type == 'getOwnershipGrpDetails'){
			var groupId = this.getParameter("sysparm_group_id");
			return this.getOwnershipGroupDetails(groupId);
		}
		else if(type == 'getAceessOfRequestOptions'){
			return this.verifyRequestTypeOptions();
		}
	},
	
	getOwnershipGroupDetails : function(groupId){
		var response ={};
		var users = [];
		if(pm.isActive("com.snc.knowledge_advanced")){
			var grp = new GlideRecord("sys_user_group");
			if(grp.get(groupId)){
				response.name =grp.getValue("name");
				response.email = grp.getValue("email");
				response.manager = grp.getValue("manager");
				response.description = grp.getValue("description");
			}
			
			if(gs.getUser().hasRole("knowledge_admin"))
				response.manager_edit = true;
			else
				response.manager_edit = false;
			
			var gr = new GlideRecord("sys_user_grmember");
			gr.addQuery('group',groupId);
			gr.query();
			while(gr.next()){
				users.push(gr.getValue("user"));
			}
			response.grpMembers = users.join();
		}
		return new JSON().encode(response);
	},
	
	
	verifyRequestTypeOptions : function(){
		var options ={};
		if(gs.getUser().hasRole("knowledge_domain_expert") || gs.getUser().hasRole("knowledge_admin")){
			options.create = true;
		}else{
			options.create = false;
		}
		if(gs.getUser().hasRole("knowledge_admin") || new KBOwnershipGroup().canEditOwnershipGroup()){
			options.edit = true;
		}else{
			options.edit = false;
		}
		return new JSON().encode(options);
	},
	
	unsubscribeUnpublishedArticle: function(sub_obj_id) {
		var gr = new GlideRecord('kb_knowledge');
		gr.get(sub_obj_id);
		if(gr.article_id.nil())
			return;
		if(!gr.canRead())
			return;
		
		var gr1 = new GlideRecord('kb_knowledge');
		gr1.addQuery('article_id',gr.article_id);
		gr1.addQuery('workflow_state','!=','published');
		gr1.addQuery('latest',true);
		gr1.query();
		if(gr1.next()) {
			if(new ActivitySubscriptionContext().getSubscriptionService().isSubscribed(gr1.sys_id).subscriptionId) {
				new ActivitySubscriptionContext().getSubscriptionService().unsubscribe(gr1.sys_id);
			}
		}
	},
	
	subscribeKbArticle: function(sub_obj_id,subs_obj_type_id) {
		if(!this._canReadArticle(sub_obj_id))
			return;
		return new ActivitySubscriptionContext().getSubscriptionService().subscribe(subs_obj_type_id,sub_obj_id);
	},
	
	unsubscribeKbArticle: function(sub_obj_id) {
		if(!this._canReadArticle(sub_obj_id))
			return;
		this.unsubscribeUnpublishedArticle(sub_obj_id);
		return new ActivitySubscriptionContext().getSubscriptionService().unsubscribe(sub_obj_id);
	},
	
	unsubscribeKB: function(sub_obj_id,sub_obj_kb_id) {
		if(!this._canReadArticle(sub_obj_id))
			return;
		new ActivitySubscriptionContext().getSubscriptionService().unsubscribe(sub_obj_kb_id);
		if(new ActivitySubscriptionContext().getSubscriptionService().isSubscribed(sub_obj_id).subscriptionId) {
			this.unsubscribeUnpublishedArticle(sub_obj_id);
			new ActivitySubscriptionContext().getSubscriptionService().unsubscribe(sub_obj_id);
			return "Article";
		}
		return "Knowledge Base";
	},
	
	_canReadArticle: function(articleId){
		var gr = new GlideRecord('kb_knowledge');
		if(!gr.get(articleId) || !gr.canRead())
			return false;
		
		return true;
	},
	
	kbWriteComment: function() {
		
		if(!this._canReadArticle(this.getParameter("sysparm_id")))
			return;
		var feedback = unescape(this.getParameter("sysparm_feedback"));
		var view_id = this.getParameter("view_id");
		var fb = new GlideRecord('kb_feedback');
		if(view_id &amp;&amp; view_id != "") {
			fb.addQuery("view_id",view_id);
			fb.query();
			if (!fb.next()) 
				view_id = gs.generateGUID();
		} else {
			view_id = gs.generateGUID();
		}
		fb.article = this.getParameter("sysparm_id");
		fb.user.setValue(gs.getUserID());
		fb.comments = feedback;
		fb.query = unescape(this.getParameter("sysparm_search"));
		fb.search_id = this.getParameter("ts_queryId") || "";
		if (this.getParameter("sysparm_flag") == "true")
			fb.flagged = "true";
		fb.view_id = view_id;
		fb.session_id = gs.getSessionID();
		fb.useful="";
		fb.insert();
	},
	
	kbAttachArticleImpl: function(value,docUrl){
		var id = value.split(',');
		var articleID = id[0];
		var taskID = id[1];
		var tsQueryId = "";
		var rankId = "";
		if(docUrl &amp;&amp; !gs.nil(docUrl)){
			var url = new GlideURL(docUrl);
			tsQueryId = url.get('sysparm_tsqueryId');
			rankId = url.get('sysparm_rank');
			if(tsQueryId &amp;&amp; rankId &amp;&amp; tsQueryId!=null &amp;&amp; !gs.nil(tsQueryId)){
				var tsQueryKb = new GlideRecord('ts_query_kb');
				tsQueryKb.get(tsQueryId);
				var prevRank = tsQueryKb.top_click_rank;
				if(prevRank!=null &amp;&amp; !gs.nil(prevRank)){
					try{
						if(parseInt(prevRank)&gt;parseInt(rankId)){
							tsQueryKb.top_click_rank =rankId;
							tsQueryKb.update();
						}
					}catch(err){
						gs.log(err.message);
					}
				}else{
					tsQueryKb.top_click_rank = rankId;
					tsQueryKb.update();
				}
			}
		}
		var article = new GlideRecord('kb_knowledge');
		if (!article.get(articleID) || !article.canRead())
			return;
		
		var kbTask = new GlideRecord('m2m_kb_task');
		kbTask.addQuery("kb_knowledge",articleID);
		kbTask.addQuery("task",taskID);
		kbTask.query();
		if (!kbTask.next()) {
			kbTask.initialize();
			kbTask.kb_knowledge = articleID;
			kbTask.task = taskID;
			kbTask.insert();
		}
		
		var paramObj = {};
		paramObj["glideSessionId"] = gs.getSessionID();
		paramObj["displayVal"] = article.getDisplayValue();
		paramObj["isFromSearchView"] = true;
		paramObj["ts_query_id"]= tsQueryId;
		paramObj["domainId"] = gs.getSession().getCurrentDomainID();
		
		gs.eventQueue("kb.use", article,JSON.stringify(paramObj), gs.getUserID());
		
		var s = "Knowledge article " + article.number + ":\n";
		if (gs.getProperty("glide.ui.security.allow_codetag", "true") != "true")
			s += article.short_description;
		else {
			var displayValue = new KnowledgeHelp(article).findDisplayValue();
			s += "[code]" + displayValue + "[/code]";
		}
		
		return s;
	},
	
	kbAttachArticle: function(value,docUrl) {
		var s = this.kbAttachArticleImpl(value,docUrl);
		
		var item = this.newItem();
		item.setAttribute("name", "text");
		item.setAttribute("value", s);
	},
	
	kbGetText: function(value) {
		var articleID = this.getParameter("article_id");
		var rating = this.getParameter("used");
		var view_id = this.getParameter("view_id");
		if(!this._canReadArticle(articleID))
			return;
		if(gs.getProperty('glide.knowman.log_ratings','true') == 'true'){
			var fb = new GlideRecord('kb_feedback');
			fb.addQuery("view_id",view_id);
			fb.query();
			if (fb.next()) {
				if (rating == 'yes' || rating == 'no')
					fb.useful = rating;
				else {
					rating = Math.round(rating);
					fb.rating = rating;
				}
				fb.update();
			} else {
				fb.initialize();
				fb.article = articleID;
				fb.user = gs.getUserID();
				if (rating == 'yes' || rating == 'no')
					fb.useful = rating;
				else {
					rating = Math.round(rating);
					fb.rating = rating;
				}
				fb.view_id = view_id;
				fb.query = unescape(this.getParameter("sysparm_search"));
				fb.session_id = gs.getSessionID();
				fb.insert();
			}
		}
	},
	verifyArticleTemplatesEnabled : function(){
		var versioningEnabled = new KBCommon().isVersioningInstalled();
		if(versioningEnabled){
			return new ArticleTemplateUtil().canContributeToTemplates();
		}
		return false;
	},
	
	type: "KnowledgeAjaxSNC"
});]]&gt;&lt;/script&gt;
        &lt;sys_class_name&gt;sys_script_include&lt;/sys_class_name&gt;
        &lt;sys_created_by&gt;admin&lt;/sys_created_by&gt;
        &lt;sys_created_on&gt;2018-12-17 09:07:33&lt;/sys_created_on&gt;
        &lt;sys_id&gt;8403647bb712230026778d78ee11a950&lt;/sys_id&gt;
        &lt;sys_mod_count&gt;5&lt;/sys_mod_count&gt;
        &lt;sys_name&gt;KnowledgeAjaxSNC&lt;/sys_name&gt;
        &lt;sys_package display_value="Knowledge Management Core" source="com.glideapp.knowledge"&gt;e011410f6d2620100acb70b353433002&lt;/sys_package&gt;
        &lt;sys_policy&gt;read&lt;/sys_policy&gt;
        &lt;sys_scope display_value="Global"&gt;global&lt;/sys_scope&gt;
        &lt;sys_update_name&gt;sys_script_include_8403647bb712230026778d78ee11a950&lt;/sys_update_name&gt;
        &lt;sys_updated_by&gt;admin&lt;/sys_updated_by&gt;
        &lt;sys_updated_on&gt;2019-11-06 07:16:21&lt;/sys_updated_on&gt;
        &lt;u_script_length&gt;8480&lt;/u_script_length&gt;
    &lt;/sys_script_include&gt;
&lt;/record_update&gt;
</payload>
        <sys_class_name>sys_metadata_link</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2022-12-19 20:29:03</sys_created_on>
        <sys_id>07ec017e2f331110d8a4d5f62799b6de</sys_id>
        <sys_name>KnowledgeAjaxSNC</sys_name>
        <sys_package display_value="Integrations 2022" source="x_644088_integrati">4c7ca0582f0c9110d8a4d5f62799b66d</sys_package>
        <sys_policy/>
        <sys_scope display_value="Integrations 2022">4c7ca0582f0c9110d8a4d5f62799b66d</sys_scope>
        <sys_update_name>sys_metadata_link_07ec017e2f331110d8a4d5f62799b6de</sys_update_name>
        <tablename>sys_script_include</tablename>
    </sys_metadata_link>
</record_update>
