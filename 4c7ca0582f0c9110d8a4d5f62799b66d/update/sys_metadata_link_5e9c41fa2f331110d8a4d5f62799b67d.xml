<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_metadata_link">
    <sys_metadata_link action="INSERT_OR_UPDATE">
        <directory>update</directory>
        <documentkey>56c8741f0a0a0b34003ec298a82ea737</documentkey>
        <payload>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;record_update table="sys_script_include"&gt;
    &lt;sys_script_include action="INSERT_OR_UPDATE"&gt;
        &lt;access&gt;package_private&lt;/access&gt;
        &lt;active&gt;true&lt;/active&gt;
        &lt;api_name&gt;global.ActionUtils&lt;/api_name&gt;
        &lt;caller_access/&gt;
        &lt;client_callable&gt;false&lt;/client_callable&gt;
        &lt;description&gt;Various utility functions to assist the execution of action scripts.&amp;#13;
Assumes the existence of an "action" global variable pointing to an instance of Action.java&amp;#13;
&amp;#13;
gs.include('ActionUtils');&amp;#13;
var au = new ActionUtils();&amp;#13;
au.&amp;lt;doSomething&amp;gt;&lt;/description&gt;
        &lt;name&gt;ActionUtils&lt;/name&gt;
        &lt;script&gt;&lt;![CDATA[gs.include("PrototypeServer");


var ActionUtils = Class.create();

ActionUtils.prototype = {
   initialize : function() {
   },
   
   postInsert : function(/* GlideRecord */ gr) {
      if (gr.isActionAborted())
         return;
      
      var linkedM2MTable = action.get('sysparm_link_collection');
      if (linkedM2MTable)
         this._insertM2M(linkedM2MTable, gr.sys_id);
      
      var relationship = action.get('sysparm_collection_relationship');
      if (relationship) {
         var parentKey = action.get('sysparm_collectionID');
         var parentTable = action.get('sysparm_collection');
         var r = GlideRelationship.get(relationship);
         r.postInsert(parentTable, parentKey, current);
      }
   },
   
   _insertM2M : function(/* String */ table, /* String */ sys_id) {
      var fromRefName = action.get('sysparm_collection_key');
      if (!fromRefName)
         return;
      
      var fromRefValue = action.get('sysparm_collectionID');
      if (!fromRefValue)
         return;
      
      var newRefName = action.get('sysparm_collection_related_field');
      if (!newRefName )
         return;
      
      var gr = new GlideRecord(table);
      if (!gr.isValid())
         return;
      
      gr.initialize();
      gr.setValue(fromRefName, fromRefValue);
      gr.setValue(newRefName, sys_id);
      gr.insert();
   },
   
   convertListActions: function() {
      var convert = [ 'action_list_button', 'action_list_contextmenu', 'action_list_choice' ];
      this._convertActions(convert);
   },
   
   convertFormActions: function() {
      var convert = [ 'action_button', 'action_menu' ];
      this._convertActions(convert);
   },
   
   _convertActions: function(convert) {
      var gr = new GlideRecord('sys_script');
      
      gr.addQuery('when', convert);
      gr.query();
      while (gr.next()) {
         var id = gr.sys_id.toString();
         var action = this._initAction(gr);

		 // first delete sys_script record since we are inserting into another table 
		 gr.deleteRecord();
		  
         // insert or update the action record after the converted from
         // sys_script record has been purged
         action.insertOrUpdate('sys_id');
      }
   },
   
   _initAction : function(gr) {
      var action = new GlideRecord('sys_ui_action');
      action.newRecord();
      // use same sys_id as old script so that customers get a predictable sys_id
      // such that we can subequently ship updates to these things
      action.setNewGuidValue(gr.sys_id);
      action.table = gr.collection;
      action.condition = gr.condition;
      action.order = gr.order;
      action.active = gr.active;
      action.name = gr.name;
      action.action_name = gr.action_name;
      action.script = gr.script;
      this._prep(action, gr);
      return action;
   },
   
   _prep : function(action, gr) {
      if (gr.action_run_at == 'client') {
         action.client = true;
         action.onclick = gr.onclick;
      }
      
      if (gr.when == 'action_button')
         action.form_button = true;
      else if (gr.when == 'action_menu')
         action.form_context_menu = true;
      else if (gr.when == 'action_list_button')
         action.list_button = true;
      else if (gr.when == 'action_list_contextmenu')
         action.list_context_menu = true;
      else if (gr.when == 'action_list_choice')
         action.list_choice = true;
   },
   
   _isAction : function(when) {
      if (when == 'action')
         return false;
      
      when = when.substring(0, 6);
      gs.print('WHEN = ' + when);
      return when == 'action';
   },
   
   convertUnloads : function() {
      var ser =  new GlideRecordXMLSerializer();
      var gr = new GlideRecord('sys_update_xml');
      gr.addQuery('name', 'STARTSWITH', 'sys_script');
      gr.query();
      while (gr.next()) {
         var xml = gr.payload + '';
         var d = GlideXMLUtil.parse(xml, true);
         var node = d.getDocumentElement().getChildNodes().item(0);
         var s = node.getLocalName();
         if (!s)
            s = node.getNodeName();
         if (s != 'sys_script')
            continue; // not a script
         
         var script = new GlideRecord('sys_script');
         script.initialize();
         ser.deserializeFromElement(script, node);
         var when = script.when + '';
         if (!this._isAction(when)) {
            gs.print('Not updating ' + gr.name + ' since it is not an action script');
            continue;
         }
         var action = this._initAction(script);
         var newPayLoad = this._createPayload(action, ser);
         gr.payload = newPayLoad;
         var oldName = gr.name + '';
         gr.name = "sys_ui_action_" + action.sys_id;
         gr.update();
         gs.print('Updated ' + oldName + ' to ' + gr.name);
      }
   },
   
   _createPayload : function(action, ser) {
      var doc = GlideXMLUtil.newDocument('record_update');
      var root = doc.getDocumentElement();
      root.setAttribute('table', 'sys_ui_action');
      var e = doc.createElement('sys_ui_action');
      root.appendChild(e);
      e.setAttribute('action', 'INSERT_OR_UPDATE');
      ser.serializeIntoElement(action, e);
      return GlideXMLUtil.toString(doc);
   }
}]]&gt;&lt;/script&gt;
        &lt;sys_class_name&gt;sys_script_include&lt;/sys_class_name&gt;
        &lt;sys_created_by&gt;glide.maint&lt;/sys_created_by&gt;
        &lt;sys_created_on&gt;2008-02-26 17:27:09&lt;/sys_created_on&gt;
        &lt;sys_id&gt;56c8741f0a0a0b34003ec298a82ea737&lt;/sys_id&gt;
        &lt;sys_mod_count&gt;46&lt;/sys_mod_count&gt;
        &lt;sys_name&gt;ActionUtils&lt;/sys_name&gt;
        &lt;sys_package display_value="System (glidesoft)" source="glidesoft"&gt;079c7c036d2220100acb70b3534330b0&lt;/sys_package&gt;
        &lt;sys_policy/&gt;
        &lt;sys_scope display_value="Global"&gt;global&lt;/sys_scope&gt;
        &lt;sys_update_name&gt;sys_script_include_56c8741f0a0a0b34003ec298a82ea737&lt;/sys_update_name&gt;
        &lt;sys_updated_by&gt;michael.hoefer&lt;/sys_updated_by&gt;
        &lt;sys_updated_on&gt;2014-06-12 23:09:07&lt;/sys_updated_on&gt;
        &lt;u_script_length&gt;5258&lt;/u_script_length&gt;
    &lt;/sys_script_include&gt;
&lt;/record_update&gt;
</payload>
        <sys_class_name>sys_metadata_link</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2022-12-19 20:27:37</sys_created_on>
        <sys_id>5e9c41fa2f331110d8a4d5f62799b67d</sys_id>
        <sys_name>ActionUtils</sys_name>
        <sys_package display_value="Integrations 2022" source="x_644088_integrati">4c7ca0582f0c9110d8a4d5f62799b66d</sys_package>
        <sys_policy/>
        <sys_scope display_value="Integrations 2022">4c7ca0582f0c9110d8a4d5f62799b66d</sys_scope>
        <sys_update_name>sys_metadata_link_5e9c41fa2f331110d8a4d5f62799b67d</sys_update_name>
        <tablename>sys_script_include</tablename>
    </sys_metadata_link>
</record_update>
