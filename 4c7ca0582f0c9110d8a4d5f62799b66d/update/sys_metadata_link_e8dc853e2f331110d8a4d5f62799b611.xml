<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_metadata_link">
    <sys_metadata_link action="INSERT_OR_UPDATE">
        <directory>update</directory>
        <documentkey>761a5a4a0a0a0b090082140b84b4900d</documentkey>
        <payload>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;record_update table="sys_script_include"&gt;
    &lt;sys_script_include action="INSERT_OR_UPDATE"&gt;
        &lt;access&gt;package_private&lt;/access&gt;
        &lt;active&gt;true&lt;/active&gt;
        &lt;api_name&gt;global.PersonalizeAggregate&lt;/api_name&gt;
        &lt;caller_access/&gt;
        &lt;client_callable&gt;true&lt;/client_callable&gt;
        &lt;description&gt;Personalize the aggregates on a column&lt;/description&gt;
        &lt;name&gt;PersonalizeAggregate&lt;/name&gt;
        &lt;script&gt;&lt;![CDATA[gs.include("PrototypeServer");

var PersonalizeAggregate = Class.create();

PersonalizeAggregate.prototype = {
  initialize: function() {
     this.viewName = "";
     this.parentName = "";
     this.relationship = "";
     this.entry = null;
     this.temporary = false;
  },

  getList: function(tableName, elementName) {
    this.tableName = tableName;
    this.element = elementName;
    this.getListEntry();
    if (this.entry == null)
       return;
    
    if (this.entry.isValidField('name'))
       var table = this.entry.name;
    else
       var table = this.entry.list_id.name;

    var chk = new GlideRecordSecure(table);
    chk.initialize();
    var element = chk.getElement(this.element);
    var eed = element.getED();

    var xml = new GlideXMLDocument("list_element");
    var e = xml.createElement("element_attributes", null);
    e.setAttribute("min", this.entry.min_value);
    e.setAttribute("max", this.entry.max_value);
    var isPrice = eed.getInternalType() == 'price' || eed.getInternalType() == 'currency';
    if (eed.isNumber() || eed.isDuration() || isPrice || eed.isMetricType()) {
       e.setAttribute("avg", this.entry.average_value);
       e.setAttribute("sum", this.entry.sum);
    } else if (eed.isDateType()) {
       e.setAttribute("avg", this.entry.average_value);
       e.setAttribute("sum", 'not_allowed'); 
    } else if (eed.isString()) {
       e.setAttribute("avg", 'not_allowed');
       e.setAttribute("sum", 'not_allowed');
    } else {
       e.setAttribute("avg", 'not_allowed');
       e.setAttribute("sum", 'not_allowed');
       e.setAttribute("min", 'not_allowed');
       e.setAttribute("max", 'not_allowed');     
    }

	if (!eed.canAvg())
       e.setAttribute("avg", 'not_allowed');
	if (!eed.canSum())
       e.setAttribute("sum", 'not_allowed');	  
	if (!eed.canMin())
       e.setAttribute("min", 'not_allowed');
	if (!eed.canMax())
       e.setAttribute("max", 'not_allowed');
	
    var document = xml.getDocument(); 
    answer = document;
    return document;
  },

  setViewName: function(viewName) {
    this.viewName = viewName;
  },

  setParent: function(parentName) {
    this.parentName = parentName;
  },
  
  setRelationship: function(relationship) {
     this.relationship = relationship;
  },
  
  update: function() {
    this.getListEntry();
    if (this.entry == null)
       return;

    this.entry.update();
    if (!this.list.isUserList() &amp;&amp; !this.temporary) {
       var u = new GlideUpdateManager2();
       u.saveListElements(this.list);
    }
    gs.cacheFlush('syscache_realform');
  },

  setSum: function(sum) {
    this.getListEntry();
    if (this.entry == null)
       return;

    this.entry.sum = sum;
  },

  setMin: function(min) {
    this.getListEntry();
    if (this.entry == null)
       return;

    this.entry.min_value = min;
  },

  setMax: function(max) {
    this.getListEntry();
    if (this.entry == null)
       return;

    this.entry.max_value = max;
  },

  setAvg: function(avg) {
    this.getListEntry();
    if (this.entry == null)
       return;

    this.entry.average_value = avg;
  },

  setList: function(tableName) {
     this.tableName = tableName;
  },

  setElement: function(elementName) {
     this.element = elementName;
  },

  getListEntry: function() {
    if (this.entry != null)
       return;

    var sl = new GlideSysList(this.tableName); 
    sl.setViewName(this.viewName);
    if (this.viewName.startsWith('rpt-temp'))
        this.temporary = true;

    sl.setRelatedParentName(this.parentName);
    sl.setRelationshipID(this.relationship);
    this.list = sl;
    var records = sl.getRecordSet();
    while (records.next()) {
       gs.log("Checking " + records.element);
       if (records.element == this.element) {
          this.entry = records;
          gs.log("Entry found");
          return;
       }
    }
  }
};
















]]&gt;&lt;/script&gt;
        &lt;sys_class_name&gt;sys_script_include&lt;/sys_class_name&gt;
        &lt;sys_created_by&gt;glide.maint&lt;/sys_created_by&gt;
        &lt;sys_created_on&gt;2007-08-17 23:13:32&lt;/sys_created_on&gt;
        &lt;sys_id&gt;761a5a4a0a0a0b090082140b84b4900d&lt;/sys_id&gt;
        &lt;sys_mod_count&gt;34&lt;/sys_mod_count&gt;
        &lt;sys_name&gt;PersonalizeAggregate&lt;/sys_name&gt;
        &lt;sys_package display_value="UI Pages (define HTML pages and their processing)" source="com.glide.ui_page"&gt;12acb4436d2220100acb70b353433096&lt;/sys_package&gt;
        &lt;sys_policy/&gt;
        &lt;sys_scope display_value="Global"&gt;global&lt;/sys_scope&gt;
        &lt;sys_update_name&gt;sys_script_include_761a5a4a0a0a0b090082140b84b4900d&lt;/sys_update_name&gt;
        &lt;sys_updated_by&gt;admin&lt;/sys_updated_by&gt;
        &lt;sys_updated_on&gt;2017-04-01 20:09:57&lt;/sys_updated_on&gt;
        &lt;u_script_length&gt;3885&lt;/u_script_length&gt;
    &lt;/sys_script_include&gt;
&lt;/record_update&gt;
</payload>
        <sys_class_name>sys_metadata_link</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2022-12-19 20:28:36</sys_created_on>
        <sys_id>e8dc853e2f331110d8a4d5f62799b611</sys_id>
        <sys_name>PersonalizeAggregate</sys_name>
        <sys_package display_value="Integrations 2022" source="x_644088_integrati">4c7ca0582f0c9110d8a4d5f62799b66d</sys_package>
        <sys_policy/>
        <sys_scope display_value="Integrations 2022">4c7ca0582f0c9110d8a4d5f62799b66d</sys_scope>
        <sys_update_name>sys_metadata_link_e8dc853e2f331110d8a4d5f62799b611</sys_update_name>
        <tablename>sys_script_include</tablename>
    </sys_metadata_link>
</record_update>
