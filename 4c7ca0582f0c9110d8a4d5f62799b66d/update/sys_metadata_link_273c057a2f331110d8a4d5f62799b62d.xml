<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_metadata_link">
    <sys_metadata_link action="INSERT_OR_UPDATE">
        <directory>update</directory>
        <documentkey>12cfefda3b231010aaec0896c3efc4ac</documentkey>
        <payload>&lt;?xml version="1.0" encoding="UTF-8"?&gt;&lt;record_update table="sys_script_include"&gt;
    &lt;sys_script_include action="INSERT_OR_UPDATE"&gt;
        &lt;access&gt;package_private&lt;/access&gt;
        &lt;active&gt;true&lt;/active&gt;
        &lt;api_name&gt;global.SystemCloneUtil&lt;/api_name&gt;
        &lt;caller_access/&gt;
        &lt;client_callable&gt;false&lt;/client_callable&gt;
        &lt;description&gt;Defines utility methods for clone profile configuration.&lt;/description&gt;
        &lt;name&gt;SystemCloneUtil&lt;/name&gt;
        &lt;script&gt;&lt;![CDATA[var SystemCloneUtil = Class.create();
SystemCloneUtil.prototype = {
	initialize: function() {
	},
	type: 'SystemCloneUtil'
};

/*
 * Validates whether clone can be submitted. 
 */
SystemCloneUtil.validateClone = function() {
	var preserverGr = new GlideAggregate(CloneConstants.tableName.CLONE_DATA_PRESERVER);
	preserverGr.addAggregate('COUNT');
	preserverGr.query();
	if(preserverGr.next() &amp;&amp; preserverGr.getAggregate('COUNT') == 0)
		return CloneConstants.errorMsg.EMPTY_PRESERVERS;
	
	return '';
};

/*
 * Validates the cleanup scripts.
 */
SystemCloneUtil.validateCleanupScript = function(current) {
	if(gs.nil(current.getValue('name')))
		return false;
	
	var cleanupScriptsGr = new GlideRecord(CloneConstants.tableName.CLONE_CLEANUP_SCRIPT);
	cleanupScriptsGr.addQuery('name', current.getValue('name'));
	cleanupScriptsGr.addQuery('sys_id', '!=', current.getValue('sys_id'));
	cleanupScriptsGr.query();
	
	if(cleanupScriptsGr.next()) 
		return false;
	
	return true;
};

SystemCloneUtil.populateProfileName = function(current) {
	var sourceTable = current.getValue('source_table');
	var profileSysId = current.getValue('profile');
	
	if(!gs.nil(sourceTable) &amp;&amp; !gs.nil(profileSysId)) {
		var gr = new GlideRecord(sourceTable);
		if(gr.get(profileSysId))
			return gr.getValue('name');
	}
	return '';
};

/*
 * Validates the exclusions.
 */
SystemCloneUtil.validateExclusion = function(current) {
	var exclusionNotAllowed = "sys_db_object";
	var tableName = current.getValue('name');
	var table = current.getValue('table');
	
	if(gs.nil(tableName) &amp;&amp; gs.nil(table))
		return false;
	
	var exclusionGr = new GlideRecord(CloneConstants.tableName.CLONE_DATA_EXCLUSION);
	if(!gs.nil(tableName)) {
		if(tableName.equals(exclusionNotAllowed) || tableName.equals(exclusionNotAllowed + ".*"))
			return tableName + " " + CloneConstants.errorMsg.EXCLUSION_NOT_ALLOWED;

		exclusionGr.addQuery('name', tableName);
	} else {
		if(table.equals(exclusionNotAllowed))
			return table + " " + CloneConstants.errorMsg.EXCLUSION_NOT_ALLOWED;

		exclusionGr.addQuery('table', table);
		exclusionGr.addQuery('condition', current.getValue('condition'));
	}
	
	exclusionGr.addQuery('sys_id', '!=', current.getValue('sys_id'));
	exclusionGr.query();
	if(exclusionGr.next()) 
		return CloneConstants.errorMsg.EXCLUSION_EXISTS;

	return '';
};

/*
 * Validates the preservers.
 */
SystemCloneUtil.validatePreserver = function(current) {
	if(gs.nil(current.getValue('table')))
		return;
	
	if (gs.tableExists("sys_db_view")) {
		var grView = new GlideRecord("sys_db_view");
		grView.addQuery('name', current.getValue('table'));
		grView.query();
		if(grView.next())
			return CloneConstants.errorMsg.PRESERVER_DB_VIEW;
	}
	
	var preserverGr = new GlideRecord(CloneConstants.tableName.CLONE_DATA_PRESERVER);
	preserverGr.addQuery('table', current.getValue('table'));
	preserverGr.addQuery('condition', current.getValue('condition'));
	preserverGr.addQuery('sys_id', '!=', current.getValue('sys_id'));
	preserverGr.query();
	if(preserverGr.next()) 
		return CloneConstants.errorMsg.PRESERVER_EXISTS;
	
	return '';
};

SystemCloneUtil.fixSystemProfileConfigForQuebec = function() {
	var securityGr = new GlideRecord('sys_security_acl');
	securityGr.addEncodedQuery('nameLIKEclone_cleanup_script.*^ORnameLIKEclone_data_exclude.*^ORnameLIKEclone_data_preserver.*^ORnameLIKEclone_profile_exclusions.*^ORnameLIKEclone_profile_preservers.*^ORnameLIKEclone_profile_cleanup_scripts.*');
	securityGr.query();
	while(securityGr.next()) {
		gs.info('ACL with sys_id ' + securityGr.getValue('sys_id') + ' deactivated.');
		securityGr.active = false;
		securityGr.update();
	}
	
	var exclusionGr = new GlideRecord(CloneConstants.tableName.CLONE_DATA_EXCLUSION);
	exclusionGr.addEncodedQuery('include_in_system_cloneISEMPTY');
	exclusionGr.query();
	while(exclusionGr.next()) {
		exclusionGr['include_in_system_clone'] = true;
		exclusionGr.setWorkflow(false);
		exclusionGr.update();
	}

	var preserverGr = new GlideRecord(CloneConstants.tableName.CLONE_DATA_PRESERVER);
	preserverGr.addEncodedQuery('include_in_system_cloneISEMPTY');
	preserverGr.query();
	while(preserverGr.next()) {
		preserverGr['include_in_system_clone'] = true;
		preserverGr.setWorkflow(false);
		preserverGr.update();
	}

	var cleanupScriptGr = new GlideRecord(CloneConstants.tableName.CLONE_CLEANUP_SCRIPT);
	cleanupScriptGr.addEncodedQuery('include_in_system_cloneISEMPTY');
	cleanupScriptGr.query();
	while(cleanupScriptGr.next()) {
		cleanupScriptGr['include_in_system_clone'] = true;
		cleanupScriptGr.setWorkflow(false);
		cleanupScriptGr.update();
	}
	
	var profileExclusionGr = new GlideRecord(CloneConstants.tableName.CLONE_PROFILE_EXCLUSION);
	profileExclusionGr.addEncodedQuery('source_tableISEMPTY');
	profileExclusionGr.query();
	while(profileExclusionGr.next()) {
		profileExclusionGr['source_table'] = 'clone_profile';
		profileExclusionGr.setWorkflow(false);
		profileExclusionGr.update();
	}
	
	var profilePreserverGr = new GlideRecord(CloneConstants.tableName.CLONE_PROFILE_PRESERVER);
	profilePreserverGr.addEncodedQuery('source_tableISEMPTY');
	profilePreserverGr.query();
	while(profilePreserverGr.next()) {
		profilePreserverGr['source_table'] = 'clone_profile';
		profilePreserverGr.setWorkflow(false);
		profilePreserverGr.update();
	}
	
	var profileCleanupScriptGr = new GlideRecord(CloneConstants.tableName.CLONE_PROFILE_CLEANUP_SCRIPT);
	profileCleanupScriptGr.addEncodedQuery('source_tableISEMPTY');
	profileCleanupScriptGr.query();
	while(profileCleanupScriptGr.next()) {
		profileCleanupScriptGr['source_table'] = 'clone_profile';
		profileCleanupScriptGr.setWorkflow(false);
		profileCleanupScriptGr.update();
	}
	
	var cloneProfileExclusionGr = new GlideRecord(CloneConstants.tableName.CLONE_PROFILE_EXCLUSION);
	cloneProfileExclusionGr.addEncodedQuery('exclusion.default=false^ORexclusion.defaultISEMPTY');
	cloneProfileExclusionGr.addQuery('profile', CloneConstants.SYSTEM_PROFILE_SYS_ID);
	cloneProfileExclusionGr.query();

	while(cloneProfileExclusionGr.next()) {
		exclusionGr = cloneProfileExclusionGr.exclusion.getRefRecord();
		if(!gs.nil(exclusionGr.getValue('sys_id'))) {
			exclusionGr['default'] = true;
			exclusionGr.setWorkflow(false);
			gs.info('Exclusion ' + exclusionGr.getValue('name') + ' default checkbox updated to true.');
			exclusionGr.update();
		}
	}

	var cloneProfilePreserverGr = new GlideRecord(CloneConstants.tableName.CLONE_PROFILE_PRESERVER);
	cloneProfilePreserverGr.addEncodedQuery('preserver.default=false^ORpreserver.defaultISEMPTY');
	cloneProfilePreserverGr.addQuery('profile', CloneConstants.SYSTEM_PROFILE_SYS_ID);
	cloneProfilePreserverGr.query();

	while(cloneProfilePreserverGr.next()) {
		preserverGr = cloneProfilePreserverGr.preserver.getRefRecord();
		if(!gs.nil(preserverGr.getValue('sys_id'))) {
			preserverGr['default'] = true;
			preserverGr.setWorkflow(false);
			gs.info('Preserver ' + preserverGr.getValue('name') + ' default checkbox updated to true.');
			preserverGr.update();
		}
	}

	var cloneProfileCleanupScriptGr = new GlideRecord(CloneConstants.tableName.CLONE_PROFILE_CLEANUP_SCRIPT);
	cloneProfileCleanupScriptGr.addEncodedQuery('cleanup_script.default=false^ORcleanup_script.defaultISEMPTY');
	cloneProfileCleanupScriptGr.addQuery('profile', CloneConstants.SYSTEM_PROFILE_SYS_ID);
	cloneProfileCleanupScriptGr.query();

	while(cloneProfileCleanupScriptGr.next()) {
		cleanupScriptGr = cloneProfileCleanupScriptGr.cleanup_script.getRefRecord();
		if(!gs.nil(cleanupScriptGr.getValue('sys_id'))) {
			cleanupScriptGr['default'] = true;
			cleanupScriptGr.setWorkflow(false);
			gs.info('Cleanup Script ' + cleanupScriptGr.getValue('name') + ' default checkbox updated to true.');
			cleanupScriptGr.update();
		}
	}
};]]&gt;&lt;/script&gt;
        &lt;sys_class_name&gt;sys_script_include&lt;/sys_class_name&gt;
        &lt;sys_created_by&gt;admin&lt;/sys_created_by&gt;
        &lt;sys_created_on&gt;2020-10-02 00:03:21&lt;/sys_created_on&gt;
        &lt;sys_id&gt;12cfefda3b231010aaec0896c3efc4ac&lt;/sys_id&gt;
        &lt;sys_mod_count&gt;22&lt;/sys_mod_count&gt;
        &lt;sys_name&gt;SystemCloneUtil&lt;/sys_name&gt;
        &lt;sys_package display_value="High Availability Cloning" source="com.snc.ha"&gt;e9adf40b6d2220100acb70b35343303a&lt;/sys_package&gt;
        &lt;sys_policy/&gt;
        &lt;sys_scope display_value="Global"&gt;global&lt;/sys_scope&gt;
        &lt;sys_update_name&gt;sys_script_include_12cfefda3b231010aaec0896c3efc4ac&lt;/sys_update_name&gt;
        &lt;sys_updated_by&gt;admin&lt;/sys_updated_by&gt;
        &lt;sys_updated_on&gt;2021-09-13 18:47:55&lt;/sys_updated_on&gt;
        &lt;u_script_length&gt;7759&lt;/u_script_length&gt;
    &lt;/sys_script_include&gt;
&lt;/record_update&gt;
</payload>
        <sys_class_name>sys_metadata_link</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2022-12-19 20:26:05</sys_created_on>
        <sys_id>273c057a2f331110d8a4d5f62799b62d</sys_id>
        <sys_name>SystemCloneUtil</sys_name>
        <sys_package display_value="Integrations 2022" source="x_644088_integrati">4c7ca0582f0c9110d8a4d5f62799b66d</sys_package>
        <sys_policy/>
        <sys_scope display_value="Integrations 2022">4c7ca0582f0c9110d8a4d5f62799b66d</sys_scope>
        <sys_update_name>sys_metadata_link_273c057a2f331110d8a4d5f62799b62d</sys_update_name>
        <tablename>sys_script_include</tablename>
    </sys_metadata_link>
</record_update>
